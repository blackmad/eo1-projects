function parseQuery(qstr) {
    var query = {};
    var a = qstr.substr(1).replace(/\+/g, ' ').split('&');
    for (var i = 0; i < a.length; i++) {
        var b = a[i].split('=');
        query[decodeURIComponent(b[0])] = decodeURIComponent(b[1] || '')
    }
    return query;
}

var params = parseQuery(window.location.search);



    var MAPS_API_KEY = "AIzaSyB3tqnSc-hYUtoQ_n-V5ZPlnBq8evTwA_M";
    var BOUNDING_BOX = {"sw_lat":40.5301893,"sw_lng":-74.2438204,"ne_lat":40.9413968,"ne_lng":-73.6870689};
    var MAP_CENTER   = {"lng":-73.9837883,"lat":40.7535342};
    var BOUNDARY     = {
      "type": "Feature",
      "properties": {
        "NAME": "New York City"
      },
      "geometry": {
        "type": "Polygon",
        "coordinates": [
          [
            [-73.68695070035756,40.93758504139249],
            [-74.2225341964513,40.94173457796413],
            [-74.2445068527013,40.529666756295015],
            [-73.70343019254506,40.540103910789284],
            [-73.68695070035756,40.93758504139249]
          ]
        ]
      }
    };
    var WATER        = {"type":"MultiPolygon","coordinates":[[[[-73.7911516,40.8544744],[-73.7814811,40.8484997],[-73.78116079999998,40.8393913],[-73.7873942,40.8397062],[-73.7915115,40.8468117],[-73.7911516,40.8544744]]],[[[-73.98816120718038,40.78135],[-73.9641769,40.8157223],[-73.950201,40.8343293],[-73.94208849999998,40.8536052],[-73.9265488,40.8775995],[-73.9209303,40.8730068],[-73.9105411,40.8721585],[-73.9125479,40.8665307],[-73.9222953,40.8556652],[-73.9348793,40.8352954],[-73.934347,40.8096162],[-73.9290426,40.8010879],[-73.9301939,40.7945974],[-73.9436341,40.7826517],[-73.9419786,40.7763499],[-73.971898,40.7427218],[-73.9734768,40.7188947],[-73.9782915,40.7104999],[-73.997195,40.7087731],[-74.0111597,40.7009097],[-74.0193432,40.706078],[-74.0132234,40.7183277],[-74.00995419999998,40.7489443],[-74.0076248,40.7542824],[-73.98816120718038,40.78135]]],[[[-73.9290831322493,40.78135],[-73.9357172,40.7856855],[-73.9283016,40.7931634],[-73.9257377,40.8017795],[-73.9137815,40.7939564],[-73.9290831322493,40.78135]]],[[[-73.883815,40.7956348],[-73.8713453,40.7901435],[-73.8736587,40.7858032],[-73.887894,40.7868835],[-73.8926919,40.7930634],[-73.883815,40.7956348]]],[[[-74.2262124980101,40.872752944904995],[-74.1301657,40.8199335],[-74.1244469,40.822169],[-74.1210869,40.831],[-74.1239869,40.838599],[-74.1192909,40.851674],[-74.1188259,40.859327],[-74.1067859,40.859299],[-74.1147869,40.874099],[-74.1301869,40.885999],[-74.12898689999999,40.893799],[-74.1337889,40.899295],[-74.1332869,40.913098],[-74.1295799,40.920071],[-74.13829589999999,40.922942],[-74.1422589,40.929757],[-74.1393609,40.933983],[-74.1450780123017,40.94113447121855],[-73.72185424135637,40.93785546331719],[-73.7273286,40.927364],[-73.7360021,40.9310319],[-73.7434718,40.9279604],[-73.7426042,40.9188219],[-73.7586385,40.9161668],[-73.76931,40.9117697],[-73.764629,40.9026737],[-73.7699141,40.8942844],[-73.7858491,40.8879105],[-73.7928909,40.8795912],[-73.7844136,40.8784977],[-73.783216,40.8713341],[-73.79196749999998,40.8667898],[-73.7915799,40.8622853],[-73.7991029,40.8537552],[-73.8062992,40.8604623],[-73.8128083,40.8588431],[-73.8174697,40.8518071],[-73.8137882,40.8452156],[-73.816563,40.8375311],[-73.8128979,40.8278073],[-73.8069911,40.824944],[-73.8049184,40.8120053],[-73.8164141,40.8139988],[-73.82970849999998,40.8110606],[-73.83737309999998,40.8059933],[-73.8578049,40.8052854],[-73.8677556,40.8106919],[-73.8717016,40.8015578],[-73.88517819999998,40.8021435],[-73.8920756,40.8063331],[-73.9021403,40.8047715],[-73.9140021,40.7969033],[-73.9274496,40.8026501],[-73.9328512,40.8101466],[-73.93325409999998,40.834944],[-73.9286535,40.8445998],[-73.9103379,40.8667848],[-73.9089428,40.8722229],[-73.9249917,40.8789113],[-73.9433748,40.8842172],[-73.9458994,40.8770136],[-73.959941,40.851603],[-73.9678095,40.8416662],[-73.9690596,40.831109],[-73.9752569,40.820521],[-73.9945992,40.7987548],[-73.9921088,40.79718],[-74.0032288,40.782269],[-74.0092766,40.7771483],[-74.0233225,40.7576455],[-74.0228139,40.7443396],[-74.0306878,40.7331866],[-74.0303463,40.7261215],[-74.0348778,40.7057435],[-74.04131779999999,40.7046842],[-74.0574754,40.6928023],[-74.0660967,40.6980622],[-74.074668,40.6875816],[-74.0766793,40.6740353],[-74.0647389,40.6691554],[-74.0706285,40.6608213],[-74.0885475,40.6675669],[-74.09170119999999,40.6655873],[-74.0872683,40.6538051],[-74.0970786,40.6492242],[-74.1130769,40.6509143],[-74.12794729999999,40.644867],[-74.1461471,40.6466337],[-74.1307258,40.6660644],[-74.1171721,40.6780051],[-74.119167,40.680097],[-74.1078022,40.6961536],[-74.1064737,40.714233],[-74.0975032,40.720136],[-74.0940537,40.7335083],[-74.0799711,40.7395483],[-74.0739088,40.7484636],[-74.0798512,40.7524171],[-74.0926386,40.7505492],[-74.0919606,40.7584487],[-74.0866618,40.7643099],[-74.0880511,40.7791036],[-74.0704037,40.7963392],[-74.0605145,40.8040796],[-74.0433764,40.8063805],[-74.0421739,40.8006105],[-74.0497576,40.7980966],[-74.0456812,40.7924248],[-74.0358674,40.7947407],[-74.0308678,40.8029844],[-74.0337447,40.8077303],[-74.0295379,40.8187244],[-74.0341343,40.8280056],[-74.0276384,40.8330858],[-74.0297647,40.8379816],[-74.0120015,40.8384825],[-74.0087476,40.8520014],[-73.9989785,40.8659408],[-74.0041919,40.866064],[-74.0120286,40.848614],[-74.0128267,40.8405047],[-74.0221214,40.8404845],[-74.0299527,40.8476051],[-74.0312503,40.8322989],[-74.0372686,40.8270648],[-74.0319331,40.8166206],[-74.035765,40.808764],[-74.0617472,40.8069473],[-74.0698775,40.7987835],[-74.0828592,40.7929368],[-74.0822538,40.7892962],[-74.0914035,40.7772199],[-74.0895152,40.7649996],[-74.09682479999998,40.7538023],[-74.0911653,40.747318],[-74.0765312,40.7478463],[-74.0777365,40.743604],[-74.0914909,40.7396127],[-74.09826909999998,40.7343011],[-74.1021182,40.7231529],[-74.1068876,40.7191163],[-74.1237112,40.7169505],[-74.1206467,40.7046326],[-74.1256303,40.695426],[-74.1360554,40.6890728],[-74.1442523,40.6799867],[-74.1388986,40.6739208],[-74.1490933379022,40.6595770310555],[-74.15678279999999,40.6627139],[-74.1739353,40.6500052],[-74.19037749999998,40.6437076],[-74.2029173,40.6331538],[-74.2071376,40.62354469999999],[-74.204828,40.6180937],[-74.20660319999999,40.6064774],[-74.2017317,40.5977345],[-74.209435,40.588579],[-74.2154099,40.5646353],[-74.2211037,40.5591144],[-74.2319795,40.562995],[-74.24304110301014,40.55715493412297],[-74.2262124980101,40.872752944904995]]],[[[-74.20765009660182,40.57071015],[-74.2046847,40.5894002],[-74.1985892,40.5949263],[-74.1959441,40.6033571],[-74.1961206,40.6154458],[-74.2005824,40.6169626],[-74.20032419999998,40.6313457],[-74.1862737,40.643558],[-74.1656143,40.6412069],[-74.1527827,40.637085],[-74.1349861,40.6417812],[-74.1241917,40.6400953],[-74.1106777,40.6451594],[-74.0933708,40.6459176],[-74.0797507,40.6484196],[-74.073179,40.6421491],[-74.0722177,40.6246405],[-74.0538166,40.6058777],[-74.0528349,40.5998344],[-74.071738,40.5818283],[-74.1050476,40.5531988],[-74.1127638,40.5477532],[-74.1276564,40.5411627],[-74.1377667,40.5457407],[-74.1417801,40.5385499],[-74.15308572900018,40.53143023356611],[-74.24220458173674,40.52971116619016],[-74.24413809999999,40.5362438],[-74.24059,40.5475529],[-74.22868,40.5562928],[-74.213737,40.5564367],[-74.20765009660182,40.57071015]]],[[[-73.70164573130161,40.58314465891975],[-73.7400683,40.5860323],[-73.7438209,40.5926747],[-73.7289584,40.590142],[-73.70140298532746,40.58899962964069],[-73.70164573130161,40.58314465891975]]],[[[-73.828025,40.635768431336],[-73.8223066,40.6346705],[-73.81477879999998,40.6089028],[-73.8253015,40.613883],[-73.8351815,40.6144672],[-73.828025,40.635768431336]]],[[[-73.828225,40.79503615143247],[-73.8207637,40.8006183],[-73.7940532,40.7943737],[-73.7937727,40.7890465],[-73.7810386,40.7917534],[-73.7740486,40.7858239],[-73.7586199,40.7673935],[-73.7533451,40.7731737],[-73.7521741,40.7822617],[-73.7534637,40.7980145],[-73.763498,40.8069093],[-73.7645096,40.8142137],[-73.7561197,40.8183644],[-73.7525565,40.8239877],[-73.7565834,40.830119],[-73.7542491,40.8353897],[-73.7424984,40.8325602],[-73.7398524,40.8285377],[-73.7215511,40.821967],[-73.7152483,40.8097579],[-73.7048469,40.8146475],[-73.70529539999998,40.8263343],[-73.71267059999998,40.8382266],[-73.722083,40.8371591],[-73.7376732,40.8477452],[-73.7272508,40.8571651],[-73.7288671,40.8662611],[-73.7197554,40.8652623],[-73.7125659,40.8698034],[-73.69009876893132,40.86165443372084],[-73.70014816913321,40.619265474844966],[-73.7081434,40.6119088],[-73.70089066109598,40.601356758880435],[-73.70128476268778,40.59185112942928],[-73.7260024,40.5941995],[-73.7453717,40.594584],[-73.7522452,40.5906485],[-73.77710849999998,40.5901987],[-73.8130993,40.5837065],[-73.8449535,40.5737481],[-73.86271569999998,40.5670307],[-73.8936116,40.55756],[-73.9091107,40.5548379],[-73.9408462,40.5424147],[-73.9407847,40.5538521],[-73.9264914,40.561424],[-73.9118643,40.5651682],[-73.9016454,40.56287],[-73.8925739,40.568586],[-73.8765047,40.5692868],[-73.8530945,40.5812586],[-73.8391443,40.5818624],[-73.8214357,40.5867828],[-73.8077864,40.5934227],[-73.8028672,40.5988444],[-73.7891014,40.5977774],[-73.7787952,40.6094448],[-73.7742995,40.6087402],[-73.7678685,40.6202822],[-73.7582554,40.6235925],[-73.7458574,40.6315242],[-73.7486904,40.6352827],[-73.7652643,40.6289448],[-73.7715227,40.6233893],[-73.7922941,40.6359297],[-73.8185008,40.6464976],[-73.82892329999999,40.6494399],[-73.8359355,40.6454966],[-73.8508855,40.6451075],[-73.8626287,40.6425222],[-73.8963147,40.6224428],[-73.8958553,40.6145467],[-73.8898444,40.6116563],[-73.8816268,40.5993879],[-73.8786208,40.5872471],[-73.8797458,40.5801621],[-73.8953116,40.5768027],[-73.8996079,40.5879227],[-73.9119693,40.5866609],[-73.91160939999999,40.5817554],[-73.9341983,40.5829618],[-73.9316609,40.5756543],[-73.9425732,40.5754207],[-73.9929602,40.570219],[-74.0020323,40.5700235],[-74.0129736,40.5780642],[-74.0002609,40.5832233],[-73.9985525,40.5904831],[-74.0113548,40.6009987],[-74.0298945,40.6046712],[-74.040513,40.615581],[-74.0411682,40.6301714],[-74.0340666,40.6442954],[-74.0282472,40.6440415],[-74.0174521,40.6594403],[-74.0085862,40.6595037],[-74.002921,40.6672402],[-74.01088609999998,40.6686529],[-74.0192798,40.6796117],[-74.009647,40.6832793],[-73.9994958,40.7003288],[-73.9943507,40.7044299],[-73.9809218,40.7059107],[-73.9740981,40.7013009],[-73.9669918,40.7173156],[-73.9611724,40.725249],[-73.9623515,40.7397999],[-73.95703989999998,40.7489289],[-73.9402278,40.7677977],[-73.9376597,40.775113],[-73.9285563,40.7765714],[-73.9097407,40.7909145],[-73.9004413,40.7890983],[-73.8917243,40.7808921],[-73.87257159999999,40.7808199],[-73.8551426,40.7722749],[-73.8594768,40.7624875],[-73.8517635,40.7594042],[-73.8478915,40.7666668],[-73.8498334,40.7823843],[-73.8552052,40.7819459],[-73.8525961,40.7944674],[-73.8384187,40.7967842],[-73.828225,40.79503615143247]]]]}
    var CITY_NAME    = 'nyc';

  //-----------------------------------------------------------------
  function getTileImage(lat,lng,id,size) {
    if (!size) {size = 256};
    var url = "https://maps.googleapis.com/maps/api/staticmap?maptype=satellite&zoom=19";
    url = url + "&center=" + lat + "," + lng;
    url = url + "&size=" + size + "x" + size;
    url = url + "&key=" + MAPS_API_KEY;
    return "<div class='tile_container'><div class='location_tile'><img alt='' src='"+url+"'/></div></div>";
  }

  var image_size = 300;

  function getTileFromFeature(feature) {
    return getTileImage(
      feature['geometry']['coordinates'][1],
      feature['geometry']['coordinates'][0],
      feature['id'],
      image_size
    )
  }

function isScrolledIntoView(el) {
    var elemTop = el.getBoundingClientRect().top;
    var elemBottom = el.getBoundingClientRect().bottom;

    var isVisible = (elemTop >= 0) && (elemBottom <= window.innerHeight);
    return isVisible;
}

function success(data) {
  console.log(data);

  var border = 25;
  var extent = image_size - border;
  var real_image_size = image_size - border*2;

  var rows = Math.floor(window.innerHeight / real_image_size);
  var cols = Math.floor(window.innerWidth / real_image_size);
  var ideal_num_tiles = (rows)*(cols);

  var images = _.map(data['features'], getTileFromFeature)
  images = _.first(images, ideal_num_tiles);

  if (images.length < ideal_num_tiles) {

  }

  _.each(images, function(imageDiv) {
    $('#image_grid').append($(imageDiv));
  })

  $('.location_tile').css('width', real_image_size + 'px');
  $('.location_tile').css('height', real_image_size + 'px');
  $('.location_tile').css('clip', 'rect(' + border + 'px,' + border + 'px,' + extent + 'px, ' + extent + 'px)');

  var even_padding = _.max([
    (window.innerWidth - (real_image_size*cols)) / (cols + 1),
    (window.innerHeight - (real_image_size*rows)) / (rows + 1)
  ])

  // $('.tile_container').css('padding', '20px')

  // $('.location_tile').css('padding-left', (window.innerWidth - (real_image_size*cols)) / (cols + 1))
  // $('.location_tile').css('padding-top', (window.innerHeight - (real_image_size*rows)) / (rows + 1))
  console.log(images)
  _.each($('.tile_container'), function(e) { if (!isScrolledIntoView(e)) { $(e).remove(); }})
}

function redraw() {
  $('.tile_container').remove()

  var lat_range = BOUNDING_BOX['ne_lat'] - BOUNDING_BOX['sw_lat']
  var rnd_lat = BOUNDING_BOX['sw_lat'] + (Math.random() * lat_range)

  var lng_range = BOUNDING_BOX['ne_lng'] - BOUNDING_BOX['sw_lng']
  var rnd_lng = BOUNDING_BOX['sw_lng'] + (Math.random() * lng_range)

  console.log('coords: ' + rnd_lat + ', ' + rnd_lng)

  $.ajax({
    dataType: "json",
    url: "/proxy/http://nyc.terrapattern.com/search?lat=" + rnd_lat + "&lng=" + rnd_lng,
    success: success
  });
}

function initialize() {
  redraw();
  var interval = 600000
  if (params['interval']) {
    interval = parseDuration(params['interval']);
  }
  setInterval(redraw, interval);
}